name: godot-tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      GODOT_VERSION: "4.5-stable"   # change if needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Godot
        run: |
          # this URL pattern is from the official download archive
          # https://godotengine.org/download/archive/4.5-stable/ :contentReference[oaicite:1]{index=1}
          URL="https://godotengine.org/download/archive/${GODOT_VERSION}/Godot_v${GODOT_VERSION}_linux.x86_64.zip"
          echo "Downloading $URL"
          curl -L "$URL" -o godot.zip
          unzip godot.zip
          # resulting filename usually: Godot_v4.5-stable_linux.x86_64
          mv Godot_v${GODOT_VERSION}_linux.x86_64 godot
          chmod +x godot

      - name: Run Godot headless
        run: |
          set -e
          ./godot --headless --path . > godot.log 2>&1 || true
          cat godot.log
          if grep -q "TestChessGame: PASS" godot.log; then
            echo "Godot test passed."
          else
            echo "Godot test failed: 'TestChessGame: PASS' not found."
            exit 1
          fi

      - name: Upload log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: godot-log
          path: godot.log
