name: godot-tests

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      GODOT_VERSION: "4.5-stable"   # change if needed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Godot
        run: |
          # this URL pattern is from the official download archive

          URL="https://downloads.godotengine.org/?version=4.5&flavor=stable&slug=linux.x86_64.zip&platform=linux.64"
          echo "Downloading $URL"
          curl -L "$URL" -o godot.zip
          unzip godot.zip
          # resulting filename usually: Godot_v4.5-stable_linux.x86_64
          mv Godot_v${GODOT_VERSION}_linux.x86_64 godot
          chmod +x godot
      # ----------------------------------------------------
      # WARM-UP EDITOR STEP (fixes UID cache issues)
      # ----------------------------------------------------
      - name: Initialize Godot project (generate .godot cache)
        run: |
          set -e
          ./godot --headless --editor --quit --path .
      # ----------------------------------------------------
      - name: Run Godot headless
        run: |
          set -e  # fail on first non-zero exit code

          # Fail immediately if Godot hits a parse/runtime error
          timeout 60 ./godot --headless --path . > godot.log 2>&1

          # Show the log in the Actions output
          cat godot.log

          if grep -q "TestChessGame: PASS" godot.log; then
            echo "Godot test passed."
          else
            echo "Godot test failed: 'TestChessGame: PASS' not found."
            exit 1
          fi

      - name: Upload log
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: godot-log
          path: godot.log
